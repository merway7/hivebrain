---
interface Props {
  entry: {
    id: number;
    title: string;
    category: string;
    tags: string;
    problem: string;
    severity: string;
    created_at: number;
  };
}

const { entry } = Astro.props;

const tags: string[] = (() => {
  try { return JSON.parse(entry.tags); }
  catch { return []; }
})();

const severity = entry.severity || 'low';

const now = Date.now() / 1000;
const diff = now - entry.created_at;
const timeAgo = diff < 3600 ? `${Math.floor(diff / 60)}m ago`
  : diff < 86400 ? `${Math.floor(diff / 3600)}h ago`
  : diff < 172800 ? 'yesterday'
  : `${Math.floor(diff / 86400)}d ago`;
---

<li class="entry-item">
  <a href={`/entry/${entry.id}`} class="entry-link">
    <div class="entry-top">
      <span class={`entry-category cat-${entry.category}`}>{entry.category}</span>
      <span class="entry-severity">{severity}</span>
      <span class="entry-date">{timeAgo}</span>
    </div>
    <div class="entry-title">{entry.title}</div>
    <div class="entry-desc">{entry.problem}</div>
    {tags.length > 0 && (
      <div class="entry-tags">
        {tags.slice(0, 5).map((t) => <span class="entry-tag">{t}</span>)}
      </div>
    )}
  </a>
</li>

<style is:global>
  .entry-item {
    padding: 12px 18px;
    border-bottom: 1px solid var(--border);
    transition: background 0.1s ease;
    list-style: none;
  }

  .entry-item:last-child {
    border-bottom: none;
  }

  .entry-item:hover {
    background: var(--bg-hover);
  }

  .entry-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .entry-top {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
  }

  .entry-category {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    padding: 2px 7px;
    border-radius: 3px;
    line-height: 1.4;
  }

  .cat-pattern   { color: var(--blue);   background: var(--blue-bg);   }
  .cat-gotcha    { color: var(--amber);  background: var(--amber-bg);  }
  .cat-debug     { color: var(--red);    background: var(--red-bg);    }
  .cat-snippet   { color: var(--green);  background: var(--green-bg);  }
  .cat-principle { color: var(--purple); background: var(--purple-bg); }

  .entry-severity {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
  }

  .entry-date {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-dim);
    margin-left: auto;
  }

  .entry-title {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-primary);
    line-height: 1.4;
    margin-bottom: 4px;
  }

  .entry-desc {
    font-size: 12px;
    color: var(--text-muted);
    line-height: 1.45;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .entry-tags {
    display: flex;
    gap: 4px;
    margin-top: 8px;
    flex-wrap: wrap;
  }

  .entry-tag {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-muted);
    background: var(--bg-overlay);
    border: 1px solid var(--border);
    padding: 1px 6px;
    border-radius: 3px;
  }
</style>
